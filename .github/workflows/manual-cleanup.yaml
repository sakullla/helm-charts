name: Force Cleanup Tags (Nuclear Option)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  cleanup-tags:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # å¿…é¡»æŠ“å–å®Œæ•´å†å²æ‰èƒ½çœ‹åˆ°æ‰€æœ‰ Tag

      - name: Hard Cleanup Git Tags
        run: |
          # 1. ç¡®ä¿æœ¬åœ°æœ‰æ‰€æœ‰è¿œç¨‹ Tag
          git fetch --tags

          # 2. è·å–æ‰€æœ‰ Chart ç›®å½•å
          ALL_CHARTS=$(ls -d charts/*/ | xargs -n 1 basename)

          echo "ğŸ“‹ Starting Hard Tag Cleanup..."

          for CHART_NAME in $ALL_CHARTS; do
            echo "---------------------------------------------------"
            echo "ğŸ” Checking Tags for: $CHART_NAME"

            # 3. åˆ—å‡ºè¯¥ Chart çš„æ‰€æœ‰ Tag
            # é€»è¾‘è¯´æ˜ï¼š
            # git tag -l: åˆ—å‡ºæ‰€æœ‰ tag
            # grep -P: ä½¿ç”¨æ­£åˆ™ä¸¥æ ¼åŒ¹é… "Chartå-æ•°å­—" æˆ– "Chartå-væ•°å­—" æ ¼å¼
            #          è¿™æ ·é˜²æ­¢ "kavita" è¯¯åŒ¹é…åˆ° "kavita-web"
            # sort -V -r: æŒ‰ç‰ˆæœ¬å·å€’åºæ’åˆ— (æœ€æ–°çš„åœ¨æœ€ä¸Šé¢)
            
            MATCHING_TAGS=$(git tag -l | grep -P "^${CHART_NAME}-v?[0-9]" | sort -V -r)

            if [ -z "$MATCHING_TAGS" ]; then
              echo "   (No tags found matching pattern)"
              continue
            fi

            # 4. ç­›é€‰å‡ºéœ€è¦åˆ é™¤çš„ Tag (è·³è¿‡å‰ 2 ä¸ªï¼Œé€‰ä¸­å‰©ä½™æ‰€æœ‰çš„)
            TAGS_TO_DELETE=$(echo "$MATCHING_TAGS" | tail -n +3)

            if [ -z "$TAGS_TO_DELETE" ]; then
              echo "âœ… $CHART_NAME is clean (Tags count <= 2)."
            else
              echo "ğŸ—‘ï¸ Found orphaned tags to delete:"
              echo "$TAGS_TO_DELETE"
              
              # 5. æ‰§è¡Œè¿œç¨‹åˆ é™¤
              # å°†æ¢è¡Œç¬¦è½¬æ¢ä¸ºç©ºæ ¼ï¼Œä¸€æ¬¡æ€§ä¼ ç»™ git push åˆ é™¤
              # æ›¿æ¢æ¢è¡Œç¬¦ä¸ºè¿™ä¸ªå‘½ä»¤éœ€è¦çš„æ ¼å¼
              for TAG in $TAGS_TO_DELETE; do
                 echo "   ğŸ”¥ Deleting remote tag: $TAG"
                 git push origin --delete "$TAG" || echo "   âš ï¸ Failed to delete $TAG (maybe already gone)"
              done
            fi
          done
          echo "ğŸ‰ Cleanup finished."