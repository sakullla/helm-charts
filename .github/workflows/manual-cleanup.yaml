name: Manual Prune index.yaml (Keep Latest Only)

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  prune-index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install yq
        uses: dcarbone/install-yq-action@v1.1.0

      - name: Prune index.yaml
        run: |
          # 1. é…ç½® Git
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

          # 2. åˆ‡æ¢åˆ° gh-pages åˆ†æ”¯ (index.yaml æ‰€åœ¨ä½ç½®)
          echo "ğŸ”„ Fetching gh-pages..."
          git fetch origin gh-pages
          git checkout gh-pages

          if [ ! -f index.yaml ]; then
            echo "âŒ Error: index.yaml not found!"
            exit 1
          fi

          echo "ğŸ“Š Before cleanup (Entry count per chart):"
          yq '.entries[] | length' index.yaml | head -n 5 || true

          # 3. æ ¸å¿ƒæ¸…æ´—å‘½ä»¤
          # é€»è¾‘ï¼šå¯¹äº entries ä¸‹çš„æ¯ä¸€ä¸ªæ•°ç»„ï¼Œåˆ é™¤ä»ç´¢å¼• 1 å¼€å§‹åˆ°ç»“æŸçš„æ‰€æœ‰å…ƒç´ 
          # ç»“æœï¼šåªä¿ç•™ç´¢å¼• 0 (æœ€æ–°ç‰ˆ)
          echo "âœ‚ï¸ Pruning..."
          yq -i 'del(.entries[][1:])' index.yaml

          echo "ğŸ“Š After cleanup (Should be 1):"
          yq '.entries[] | length' index.yaml | head -n 5 || true

          # 4. æäº¤æ›´æ”¹
          if [[ -n $(git status -s) ]]; then
            echo "ğŸ’¾ Committing changes..."
            git add index.yaml
            git commit -m "chore: force prune index.yaml to keep only latest versions"
            git push origin gh-pages
            echo "âœ… index.yaml has been cleaned and pushed!"
          else
            echo "âœ… index.yaml was already clean."
          fi