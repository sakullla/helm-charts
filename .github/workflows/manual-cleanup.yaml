name: Manual Force Cleanup (Fix Limits)
on: workflow_dispatch

permissions:
  contents: write

jobs:
  cleanup-all:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Force Cleanup All Charts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # è·å–æ‰€æœ‰ Chart åå­—
          ALL_CHARTS=$(ls -d charts/*/ | xargs -n 1 basename)

          for CHART_NAME in $ALL_CHARTS; do
            echo "ğŸ” Checking Chart: $CHART_NAME"

            # å…³é”®ä¿®å¤ï¼š--limit 1000
            # ç¡®ä¿å³ä½¿æ˜¯å¾ˆä¹…ä»¥å‰çš„å‘å¸ƒä¹Ÿèƒ½è¢«æ‰«æåˆ°
            # tail -n +3 è¡¨ç¤ºä¿ç•™å‰2ä¸ª(1,2)ï¼Œåˆ é™¤ç¬¬3ä¸ªåŠä»¥å
            RELEASES_TO_DELETE=$(gh release list \
              --limit 1000 \
              --order desc \
              --json tagName \
              --jq ".[] | select(.tagName | startswith(\"$CHART_NAME-\")) | .tagName" \
              | tail -n +3)

            if [ -z "$RELEASES_TO_DELETE" ]; then
              echo "âœ… $CHART_NAME is clean."
            else
              echo "ğŸ—‘ï¸ Deleting old versions for $CHART_NAME..."
              echo "$RELEASES_TO_DELETE" | xargs -r -I {} gh release delete "{}" --cleanup-tag -y
            fi
          done