name: Manual Cleanup All Tags

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®è§¦å‘

permissions:
  contents: write

jobs:
  cleanup-all:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Cleanup All Old Releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # è·å– charts ç›®å½•ä¸‹æ‰€æœ‰çš„æ–‡ä»¶å¤¹å
          ALL_CHARTS=$(ls -d charts/*/ | xargs -n 1 basename)

          echo "ğŸš€ Starting Full Cleanup for: $ALL_CHARTS"

          for CHART_NAME in $ALL_CHARTS; do
            echo "---------------------------------------------------"
            echo "ğŸ” Checking Chart: $CHART_NAME"

            # åˆ—å‡ºè¯¥ Chart çš„æ‰€æœ‰ Tagï¼Œä¿ç•™æœ€æ–°çš„ 2 ä¸ª
            RELEASES_TO_DELETE=$(gh release list \
              --limit 100 \
              --order desc \
              --json tagName \
              --jq ".[] | select(.tagName | startswith(\"$CHART_NAME-\")) | .tagName" \
              | tail -n +3)

            if [ -z "$RELEASES_TO_DELETE" ]; then
              echo "âœ… Clean."
            else
              echo "ğŸ—‘ï¸ Found old versions. Deleting..."
              echo "$RELEASES_TO_DELETE"
              echo "$RELEASES_TO_DELETE" | xargs -r -I {} gh release delete "{}" --cleanup-tag -y
            fi
          done
          echo "ğŸ‰ All cleanup done!"