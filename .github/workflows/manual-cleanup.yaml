name: Manual Prune index.yaml (Python Version)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  prune-index:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Checkout gh-pages
        run: |
          echo "ğŸ”„ Fetching gh-pages..."
          git fetch origin gh-pages
          git checkout gh-pages
          
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Prune index.yaml with Python
        shell: python
        run: |
          import yaml
          import os

          file_path = 'index.yaml'
          
          if not os.path.exists(file_path):
              print(f"âŒ Error: {file_path} not found.")
              exit(1)

          print("ğŸ“– Reading index.yaml...")
          with open(file_path, 'r') as f:
              data = yaml.safe_load(f)

          changes_made = False
          
          # éå†æ‰€æœ‰ Chart
          if 'entries' in data:
              for chart_name, versions in data['entries'].items():
                  original_count = len(versions)
                  if original_count > 1:
                      # å¼ºåˆ¶ä¿ç•™ç¬¬ä¸€ä¸ªå…ƒç´ ï¼ˆæœ€æ–°ç‰ˆï¼‰ï¼Œä¸¢å¼ƒå…¶ä½™
                      print(f"âœ‚ï¸ Pruning {chart_name}: {original_count} -> 1")
                      data['entries'][chart_name] = [versions[0]]
                      changes_made = True
          
          if changes_made:
              print("ğŸ’¾ Writing changes back to index.yaml...")
              with open(file_path, 'w') as f:
                  # default_flow_style=False ä¿æŒ YAML æ ¼å¼ç¾è§‚
                  yaml.dump(data, f, default_flow_style=False, sort_keys=False)
          else:
              print("ğŸ‰ No changes needed.")

      # ä¿®å¤äº†è¿™é‡Œçš„å¼•å·å’Œè¯­æ³•é—®é¢˜
      - name: Commit and Push
        run: |
          # 1. æ£€æŸ¥ index.yaml æ˜¯å¦æœ‰å˜åŒ–
          if git diff --quiet index.yaml; then
            echo "âœ… No changes detected in index.yaml. Everything is clean."
          
          else
            echo "ğŸ“¦ Changes detected. Committing..."
            
            git add index.yaml
            git commit -m "chore: prune index.yaml via python script [skip ci]"
            
            # 2. ä½¿ç”¨ Token è¿›è¡Œæ¨é€
            git push "https://${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" gh-pages
            
            echo "âœ… Successfully pushed cleaned index.yaml!"
          fi  
          # â¬†ï¸â¬†ï¸â¬†ï¸ å¿…é¡»è¦æœ‰è¿™ä¸ª fiï¼Œä¸”ç¼©è¿›è¦å’Œä¸Šé¢çš„ if å¯¹é½