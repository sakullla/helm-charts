name: Manual Cleanup (Keep Only 1)
on: workflow_dispatch

permissions:
  contents: write

jobs:
  cleanup-all:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Cleanup All Old Releases (Keep 1)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ALL_CHARTS=$(ls -d charts/*/ | xargs -n 1 basename)
          
          for CHART_NAME in $ALL_CHARTS; do
            echo "ğŸ” Checking Chart: $CHART_NAME"

            # å…³é”®ä¿®æ”¹ï¼štail -n +2 (ä¿ç•™1ä¸ªï¼Œåˆ é™¤å…¶ä½™æ‰€æœ‰)
            RELEASES_TO_DELETE=$(gh release list \
              --limit 100 \
              --order desc \
              --json tagName \
              --jq ".[] | select(.tagName | startswith(\"$CHART_NAME-\")) | .tagName" \
              | tail -n +2)

            if [ -z "$RELEASES_TO_DELETE" ]; then
              echo "âœ… $CHART_NAME: Clean (Only latest remains)."
            else
              echo "ğŸ—‘ï¸ Deleting old versions:"
              echo "$RELEASES_TO_DELETE"
              echo "$RELEASES_TO_DELETE" | xargs -r -I {} gh release delete "{}" --cleanup-tag -y
            fi
          done