name: Release Charts

on:
  push:
    branches:
      - main
    paths:
      - 'charts/**'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@v3

      # ------------------------------------------------------------------
      # 1. å‘å¸ƒç¯èŠ‚
      # ------------------------------------------------------------------
      - name: Run chart-releaser
        uses: helm/chart-releaser-action@v1.5.0
        with:
          charts_dir: charts
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

      # ------------------------------------------------------------------
      # 2. æ¸…ç† index.yaml (Python å¼ºåŠ›ç‰ˆ - åªä¿ç•™æœ€æ–° 1 ä¸ªç‰ˆæœ¬)
      # ------------------------------------------------------------------
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Prune index.yaml (Keep Latest Only)
        shell: python
        run: |
          import yaml
          import os
          import subprocess

          # 1. åˆ‡æ¢åˆ° gh-pages è·å–æœ€æ–°çš„ index.yaml
          print("ğŸ”„ Fetching gh-pages...")
          subprocess.run(["git", "fetch", "origin", "gh-pages"], check=True)
          subprocess.run(["git", "checkout", "gh-pages"], check=True)

          file_path = 'index.yaml'
          if not os.path.exists(file_path):
              print(f"âŒ Error: {file_path} not found.")
              exit(0) # å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡å‘å¸ƒå¯èƒ½è¿˜æ²¡æ–‡ä»¶ï¼Œä¸æŠ¥é”™

          print("ğŸ“– Reading index.yaml...")
          with open(file_path, 'r') as f:
              data = yaml.safe_load(f)

          changes_made = False
          
          # 2. è£å‰ªé€»è¾‘ï¼šæ¯ä¸ª Chart åªç•™åˆ—è¡¨ç¬¬ 0 é¡¹
          if 'entries' in data:
              for chart_name, versions in data['entries'].items():
                  original_count = len(versions)
                  if original_count > 1:
                      print(f"âœ‚ï¸ Pruning {chart_name}: {original_count} -> 1")
                      data['entries'][chart_name] = [versions[0]]
                      changes_made = True
          
          # 3. å¦‚æœæœ‰æ”¹åŠ¨ï¼Œå†™å›æ–‡ä»¶å¹¶æäº¤
          if changes_made:
              print("ğŸ’¾ Writing changes back to index.yaml...")
              with open(file_path, 'w') as f:
                  yaml.dump(data, f, default_flow_style=False, sort_keys=False)
              
              print("ğŸ“¦ Committing changes...")
              subprocess.run(["git", "add", "index.yaml"], check=True)
              subprocess.run(["git", "commit", "-m", "chore: prune index.yaml [skip ci]"], check=True)
              
              # æ¨é€ (æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨ token url é¿å…æƒé™é—®é¢˜ï¼ŒPython ä¸­éœ€ç”¨ subprocess è°ƒç”¨ git push)
              repo_url = f"https://{os.environ['GITHUB_ACTOR']}:{os.environ['GH_TOKEN']}@github.com/{os.environ['GITHUB_REPOSITORY']}.git"
              subprocess.run(["git", "push", repo_url, "gh-pages"], check=True)
              print("âœ… index.yaml cleaned and pushed.")
          else:
              print("âœ… index.yaml is already clean.")
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_REPOSITORY: ${{ github.repository }}

      # åˆ‡å› main åˆ†æ”¯ï¼Œè™½ç„¶ workflow å³å°†ç»“æŸï¼Œä½†æ˜¯ä¸ªå¥½ä¹ æƒ¯
      - name: Checkout Main
        run: git checkout main

      # ------------------------------------------------------------------
      # 3. æ¸…ç†æ—§ Release/Tag (åªä¿ç•™æœ€è¿‘ 2 ä¸ª)
      # ------------------------------------------------------------------
      - name: Cleanup Old Releases (Keep last 2)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # A. è·å–æœ¬æ¬¡å˜æ›´çš„ chart
          CHANGED_CHARTS=$(git diff --name-only HEAD^ HEAD | grep '^charts/' | cut -d/ -f2 | sort -u)

          if [ -z "$CHANGED_CHARTS" ]; then
             echo "ğŸ¤” No charts modified in this push. Skipping partial cleanup."
             # å¦‚æœä½ æƒ³æ¯æ¬¡éƒ½å…¨é‡æ£€æŸ¥ï¼Œå–æ¶ˆä¸‹é¢è¿™è¡Œçš„æ³¨é‡Š:
             # CHANGED_CHARTS=$(ls -d charts/*/ | xargs -n 1 basename)
             exit 0
          fi

          echo "ğŸ“‹ Target Charts for cleanup: $CHANGED_CHARTS"

          for CHART_NAME in $CHANGED_CHARTS; do
            if [ ! -d "charts/$CHART_NAME" ]; then continue; fi

            echo "ğŸ§¹ Checking cleanup for Chart: $CHART_NAME ..."

            # B. æ ¸å¿ƒé€»è¾‘
            # --limit 1000: å…³é”®ä¼˜åŒ–ï¼Œé˜²æ­¢ç‰ˆæœ¬å¤ªå¤šæœä¸åˆ°
            # tail -n +3: ä¿ç•™å‰2ä¸ªï¼Œä»ç¬¬3ä¸ªå¼€å§‹åˆ 
            RELEASES_TO_DELETE=$(gh release list \
              --limit 1000 \
              --order desc \
              --json tagName \
              --jq ".[] | select(.tagName | startswith(\"$CHART_NAME-\")) | .tagName" \
              | tail -n +3)

            if [ -z "$RELEASES_TO_DELETE" ]; then
              echo "  âœ… $CHART_NAME has 2 or fewer releases. Clean."
            else
              echo "  ğŸ—‘ï¸ Deleting old releases:"
              echo "$RELEASES_TO_DELETE"
              echo "$RELEASES_TO_DELETE" | xargs -r -I {} gh release delete "{}" --cleanup-tag -y
            fi
          done