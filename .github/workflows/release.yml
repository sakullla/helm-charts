name: Release Charts

on:
  push:
    branches:
      - main
    paths:
      - 'charts/**'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@v3

      - name: Run chart-releaser
        uses: helm/chart-releaser-action@v1.5.0
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

      - name: Cleanup Old Releases (Keep last 5)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. è·å– charts ç›®å½•ä¸‹æ‰€æœ‰çš„ chart åå­— (ä¾‹å¦‚ certimate, project-b)
          # è¿™é‡Œçš„ ls -d charts/*/ ä¼šåˆ—å‡ºç›®å½•ï¼Œxargs basename åªå–æ–‡ä»¶å¤¹å
          CHARTS=$(ls -d charts/*/ | xargs -n 1 basename)

          # 2. éå†æ¯ä¸€ä¸ª Chart
          for CHART_NAME in $CHARTS; do
            echo "ğŸ§¹ æ­£åœ¨æ£€æŸ¥æ¸…ç† Chart: $CHART_NAME ..."

            # 3. ä½¿ç”¨ gh å‘½ä»¤è¡Œåˆ—å‡ºè¯¥ Chart çš„æ‰€æœ‰ Release
            # --limit 100:ä»¥æ­¤é˜²æ­¢åˆ†é¡µé—®é¢˜
            # jq è¿‡æ»¤: ç­›é€‰å‡º tag åå­—ä»¥ "chartå-" å¼€å¤´çš„ release
            # tail -n +6: ä¿ç•™å‰5ä¸ªï¼Œä»ç¬¬6ä¸ªå¼€å§‹é€‰ä¸­ï¼ˆå³å‡†å¤‡åˆ é™¤çš„ç›®æ ‡ï¼‰
            
            RELEASE_TO_DELETE=$(gh release list --limit 100 --json tagName --jq ".[] | select(.tagName | startswith(\"$CHART_NAME-\")) | .tagName" | tail -n +6)

            if [ -z "$RELEASE_TO_DELETE" ]; then
              echo "   âœ… $CHART_NAME ç‰ˆæœ¬æ•°é‡æœªè¶…è¿‡ 5 ä¸ªï¼Œæ— éœ€æ¸…ç†ã€‚"
            else
              echo "   ğŸ—‘ï¸ å‘ç°æ—§ç‰ˆæœ¬ï¼Œå‡†å¤‡åˆ é™¤:"
              echo "$RELEASE_TO_DELETE"
              
              # 4. æ‰§è¡Œåˆ é™¤æ“ä½œ (åˆ é™¤ Release åŒæ—¶ä¹Ÿåˆ é™¤ Tag)
              # --cleanup-tag: åŒæ—¶åˆ é™¤å¯¹åº”çš„ git tag
              # -y: ä¸è¯¢é—®ç›´æ¥ç¡®è®¤
              echo "$RELEASE_TO_DELETE" | xargs -I {} gh release delete "{}" --cleanup-tag -y
            fi
          done