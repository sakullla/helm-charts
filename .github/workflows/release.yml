name: Release Charts

on:
  push:
    branches:
      - main
    paths:
      - 'charts/**'

permissions:
  contents: write # å…è®¸å‘å¸ƒ Release å’Œæ¨é€ä»£ç 

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # å¿…é¡»è·å–å®Œæ•´å†å²ä»¥æ£€æµ‹å˜æ›´

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@v3

      - name: Install yq
        uses: dcarbone/install-yq-action@v1.1.0 # å®‰è£… yq ç”¨äºå¤„ç† yaml

      # 1. å‘å¸ƒè¿‡ç¨‹ï¼šchart-releaser ä¼šè‡ªåŠ¨æ£€æµ‹ç‰ˆæœ¬å˜åŒ–ï¼Œåªå‘å¸ƒæ›´æ–°çš„ Chart
      - name: Run chart-releaser
        uses: helm/chart-releaser-action@v1.5.0
        with:
          charts_dir: charts
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

      # 2. æ¸…ç† index.yamlï¼šåªä¿ç•™æœ€æ–°ç‰ˆæœ¬
      # åˆ‡æ¢åˆ° gh-pages åˆ†æ”¯ï¼ˆcr action é»˜è®¤å‘å¸ƒåˆ°æ­¤åˆ†æ”¯ï¼‰ï¼Œç”¨ yq è£å‰ª yaml
      - name: Prune index.yaml (Keep Only Latest)
        run: |
          echo "ğŸ“¥ Checking out gh-pages to prune index.yaml..."
          git fetch origin gh-pages
          git checkout gh-pages
          
          if [ -f index.yaml ]; then
            echo "âœ‚ï¸ Pruning index.yaml to keep only the latest version per chart..."
            # yq å‘½ä»¤å«ä¹‰ï¼šéå†æ‰€æœ‰ entriesï¼Œå¯¹äºæ¯ä¸ªæ•°ç»„ï¼Œåˆ é™¤ç´¢å¼• 1 åŠä¹‹åçš„å†…å®¹ï¼ˆåªç•™ç´¢å¼•0ï¼Œå³æœ€æ–°ç‰ˆï¼‰
            yq -i 'del(.entries[][1:])' index.yaml
            
            # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–ï¼Œæœ‰åˆ™æäº¤
            if [[ -n $(git status -s) ]]; then
              git commit -am "chore: prune index.yaml to latest version only"
              git push origin gh-pages
              echo "âœ… index.yaml pruned and pushed."
            else
              echo "âœ… index.yaml is already clean."
            fi
          else
            echo "âš ï¸ No index.yaml found, skipping."
          fi
          
          # åˆ‡å› main åˆ†æ”¯ä»¥ä¾¿åç»­è„šæœ¬èƒ½æ­£ç¡®è¯»å–ç›®å½•ç»“æ„ï¼ˆè™½ç„¶æœ¬ä¾‹ä¸­æ¸…ç†è„šæœ¬ä¸å¼ºä¾èµ– mainï¼Œä½†ä¿æŒä¹ æƒ¯ï¼‰
          git checkout main

      # 3. æ¸…ç†æ—§ç‰ˆæœ¬ Release/Tagï¼šåªä¿ç•™æœ€è¿‘ 2 ä¸ª
      # ä»…é’ˆå¯¹æœ¬æ¬¡ Push æ¶‰åŠçš„ Chart è¿›è¡Œæ£€æŸ¥
      - name: Cleanup Old Releases (Keep last 2)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # è·å–æœ¬æ¬¡æäº¤å˜æ›´çš„ Chart åˆ—è¡¨
          # git diff æ¯”è¾ƒå½“å‰ SHA ä¸ä¸Šä¸€æ¬¡æäº¤ï¼Œè¿‡æ»¤ charts/ ç›®å½•ï¼Œæå–ä¸€çº§ç›®å½•å
          CHANGED_CHARTS=$(git diff --name-only HEAD^ HEAD | grep '^charts/' | cut -d/ -f2 | sort -u)

          if [ -z "$CHANGED_CHARTS" ]; then
            echo "ğŸ¤” No charts modified in this push. Checking all charts just in case..."
            CHANGED_CHARTS=$(ls -d charts/*/ | xargs -n 1 basename)
          fi

          echo "ğŸ“‹ Target Charts for cleanup: $CHANGED_CHARTS"

          for CHART_NAME in $CHANGED_CHARTS; do
            # å†æ¬¡ç¡®è®¤ç›®å½•å­˜åœ¨ï¼ˆé˜²æ­¢åˆ é™¤æ–‡ä»¶çš„æƒ…å†µï¼‰
            if [ ! -d "charts/$CHART_NAME" ]; then continue; fi

            echo "ğŸ§¹ Checking cleanup for Chart: $CHART_NAME ..."

            # åˆ—å‡ºè¯¥ Chart çš„æ‰€æœ‰ Releaseï¼ŒæŒ‰æ—¶é—´å€’åº
            # tail -n +3: ä¿ç•™å‰2ä¸ª(ç¬¬1,2è¡Œ)ï¼Œä»ç¬¬3ä¸ªå¼€å§‹é€‰ä¸­ç”¨äºåˆ é™¤
            RELEASES_TO_DELETE=$(gh release list --limit 100 --json tagName --jq ".[] | select(.tagName | startswith(\"$CHART_NAME-\")) | .tagName" | tail -n +3)

            if [ -z "$RELEASES_TO_DELETE" ]; then
              echo "  âœ… $CHART_NAME has 2 or fewer releases. No cleanup needed."
            else
              echo "  ğŸ—‘ï¸ Deleting old releases (keeping top 2):"
              echo "$RELEASES_TO_DELETE"
              
              # æ‰¹é‡åˆ é™¤ Release å’Œ Tag
              echo "$RELEASES_TO_DELETE" | xargs -I {} gh release delete "{}" --cleanup-tag -y
            fi
          done