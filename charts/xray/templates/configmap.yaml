apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "xray.fullname" . }}-config
  labels:
    {{- include "xray.labels" . | nindent 4 }}
data:
  config.json: |
    {{- /* 1. 读取 Secret */ -}}
    {{- $secretObj := (lookup "v1" "Secret" .Release.Namespace (printf "%s-auth" (include "xray.fullname" .))) | default dict }}
    {{- $secretData := $secretObj.data | default dict }}

    {{- /* 2. 深度拷贝配置 */ -}}
    {{- $config := deepCopy .Values.xrayConfig -}}
    
    {{- /* 3. 遍历所有 Inbound 进行注入 */ -}}
    {{- range $config.inbounds -}}
      {{- $settings := .settings -}}
      
      {{- if $settings -}}
        
        {{- /* --- A. 准备长度逻辑 (用于兜底生成) --- */ -}}
        {{- $method := $settings.method | default "2022-blake3-aes-128-gcm" -}}
        {{- $keyLen := 16 -}}
        {{- if or (contains "256" $method) (contains "chacha20" $method) -}}
          {{- $keyLen = 32 -}}
        {{- end -}}
        
        {{- /* --- B. 注入服务端密码 --- */ -}}
        {{- /* 构造 Key 名: "tag-password" */ -}}
        {{- $srvKeyName := printf "%s-password" .tag -}}
        {{- $srvPass := "" -}}
        
        {{- if and $settings.password (ne $settings.password "auto") -}}
           {{- $srvPass = $settings.password -}}
        {{- else if hasKey $secretData $srvKeyName -}}
           {{- $srvPass = index $secretData $srvKeyName | b64dec -}}
        {{- else -}}
           {{- $srvPass = randAlphaNum $keyLen | b64enc -}}
        {{- end -}}
        {{- $_ := set $settings "password" $srvPass -}}

        {{- /* --- C. 注入客户端列表 --- */ -}}
        {{- if $settings.clients -}}
            {{- $newClients := list -}}
            {{- range $index, $user := $settings.clients -}}
                {{- /* 构造 Key 名: "tag-client-N-password" */ -}}
                {{- $clientKeyName := printf "%s-client-%d-password" $.tag $index -}}
                {{- $cliPass := "" -}}
                
                {{- if and $user.password (ne $user.password "auto") -}}
                    {{- $cliPass = $user.password -}}
                {{- else if hasKey $secretData $clientKeyName -}}
                    {{- $cliPass = index $secretData $clientKeyName | b64dec -}}
                {{- else -}}
                    {{- $cliPass = randAlphaNum $keyLen | b64enc -}}
                {{- end -}}
                
                {{- $clientObj := dict "email" $user.email "password" $cliPass -}}
                {{- $newClients = append $newClients $clientObj -}}
            {{- end -}}
            {{- $_ := set $settings "clients" $newClients -}}
        {{- end -}}
      
      {{- end -}}
    {{- end -}}
    
    {{- $config | toPrettyJson | nindent 4 }}