{{- if not .Values.useHostPort -}}
apiVersion: v1
kind: Service
metadata:
  name: {{ include "xray.fullname" . }}
  labels:
    {{- include "xray.labels" . | nindent 4 }}
spec:
  type: ClusterIP
  {{- if .Values.service.ipFamilyPolicy }}
  ipFamilyPolicy: {{ .Values.service.ipFamilyPolicy }}
  {{- end }}
  {{- if .Values.service.ipFamilies }}
  ipFamilies:
    {{- toYaml .Values.service.ipFamilies | nindent 4 }}
  {{- end }}
  {{- if .Values.serviceExternalIPs }}
  externalIPs:
    {{- toYaml .Values.serviceExternalIPs | nindent 4 }}
  {{- end }}
  selector:
    {{- include "xray.selectorLabels" . | nindent 4 }}
  
  # [鏍稿績閫昏緫] 鍚屾牱鏍规嵁 inbound 鍔ㄦ€佺敓鎴?Service 绔彛
  ports:
  {{- range $index, $inbound := .Values.xrayConfig.inbounds }}
    {{- $net := $inbound.settings.network | default "tcp" }}
    
    {{- /* TCP */ -}}
    {{- if contains "tcp" $net }}
    - name: inbound-{{ $index }}-tcp
      port: {{ $inbound.port }}
      targetPort: {{ $inbound.port }}
      protocol: TCP
    {{- end }}

    {{- /* UDP */ -}}
    {{- if contains "udp" $net }}
    - name: inbound-{{ $index }}-udp
      port: {{ $inbound.port }}
      targetPort: {{ $inbound.port }}
      protocol: UDP
    {{- end }}
  {{- end }}
{{- end -}}

